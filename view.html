<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»“åº“æµè§ˆ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“¦</text></svg>">
    <style>
        body { font-family: -apple-system, sans-serif; background: #f8f9fa; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .back-link { text-decoration: none; color: #666; font-size: 0.9rem; }
        .back-link:hover { color: #000; }
        
        /* æœç´¢æ¡† */
        #search { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; margin-bottom: 20px; }
        
        /* è¡¨æ ¼æ ·å¼ */
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { color: #666; font-weight: 600; font-size: 0.9rem; }
        tr:hover { background-color: #f8f9fa; }
        
        .pkg-name { color: #0066cc; font-weight: 500; font-family: monospace; font-size: 1.1em; }
        .pkg-ver { color: #666; font-family: monospace; }
        .download-btn { display: inline-block; padding: 6px 12px; background: #e7f5ff; color: #0066cc; text-decoration: none; border-radius: 4px; font-size: 0.85rem; }
        .download-btn:hover { background: #0066cc; color: #fff; }

        .loading { text-align: center; color: #999; padding: 40px; }
        .error { color: #dc3545; text-align: center; padding: 20px; background: #ffe6e6; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 id="repo-title">ğŸ“¦ åŠ è½½ä¸­...</h1>
        <a href="index.html" class="back-link">â† è¿”å›ä¸»é¡µ</a>
    </div>

    <input type="text" id="search" placeholder="ğŸ” æœç´¢è½¯ä»¶åŒ…..." onkeyup="filterPackages()">

    <div id="content">
        <div class="loading">æ­£åœ¨è·å–ç´¢å¼•æ–‡ä»¶...</div>
    </div>
    <footer>
    <div id="version-info" style="margin-bottom: 10px; font-family: monospace; font-size: 0.8em; color: #888;">
        <span>Ver: loading...</span> | <span>Date: loading...</span>
    </div>
    &copy; 2026 Yaojiu.org | Powered by GitHub Pages
</footer>
</div>

<script>
    (function() {
        // configuration
        const GITHUB_USER = 'Ye-Ethan'; // æ›¿æ¢ä½ çš„ GitHub ç”¨æˆ·å
        const GITHUB_REPO = 'opwnwrt-opkg-source';       // æ›¿æ¢ä½ çš„ä»“åº“å (ä¾‹å¦‚ opkg-repo)
        
        // æ ¼å¼åŒ–æ—¥æœŸçš„å‡½æ•° (YYYY-MM-DD HH:mm)
        function formatDate(isoString) {
            const date = new Date(isoString);
            const pad = (n) => n.toString().padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        // è·å–æœ€è¿‘ä¸€æ¬¡ Commit ä¿¡æ¯
        fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/commits?per_page=1`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                // GitHub API è¿”å›çš„æ˜¯æ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ªå³ä¸ºæœ€æ–° commit
                const latest = data[0];
                const sha = latest.sha.substring(0, 7); // æˆªå–å‰7ä½ Hash
                const date = latest.commit.committer.date; // è·å–æäº¤æ—¶é—´
                
                // æ›´æ–° DOM
                const infoDiv = document.getElementById('version-info');
                if (infoDiv) {
                    infoDiv.innerHTML = `
                        <span>Build: <a href="${latest.html_url}" target="_blank" style="color: inherit; text-decoration: none; border-bottom: 1px dashed #999;">${sha}</a></span>
                        <span style="margin: 0 8px;">|</span>
                        <span>Updated: ${formatDate(date)}</span>
                    `;
                }
            })
            .catch(error => {
                console.error('æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯:', error);
                const infoDiv = document.getElementById('version-info');
                if(infoDiv) infoDiv.style.display = 'none'; // è·å–å¤±è´¥åˆ™éšè—
            });
    })();
</script>

<script>
    // 1. è·å– URL å‚æ•°ä¸­çš„ repo åç§° (ä¾‹å¦‚ base, luci)
    const urlParams = new URLSearchParams(window.location.search);
    const repoName = urlParams.get('repo');

    // 2. éªŒè¯å‚æ•°
    if (!repoName) {
        document.getElementById('content').innerHTML = '<div class="error">é”™è¯¯ï¼šæœªæŒ‡å®šä»“åº“è·¯å¾„ (å¦‚ ?repo=base)</div>';
    } else {
        document.getElementById('repo-title').innerText = `ğŸ“¦ ä»“åº“: ${repoName}`;
        document.title = `${repoName} - OpenWrt ä»“åº“`;
        fetchData(repoName);
    }

    let allPackages = []; // å­˜å‚¨æ‰€æœ‰åŒ…æ•°æ®ç”¨äºæœç´¢

    // 3. è·å– JSON æ•°æ®
    async function fetchData(path) {
        try {
            // å‡è®¾ index.json ä½äºå¯¹åº”çš„å­ç›®å½•ä¸­
            const response = await fetch(`${path}/index.json`);
            if (!response.ok) throw new Error(`HTTP é”™è¯¯! çŠ¶æ€: ${response.status}`);
            
            const data = await response.json();
            renderTable(data);
        } catch (error) {
            console.error(error);
            document.getElementById('content').innerHTML = `
                <div class="error">
                    æ— æ³•åŠ è½½ <strong>${path}/index.json</strong>ã€‚<br>
                    è¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä»¥åŠ JSON æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚<br>
                    <small>${error.message}</small>
                </div>`;
        }
    }

    // 4. æ¸²æŸ“è¡¨æ ¼
    function renderTable(data) {
        const arch = data.architecture;
        const packages = data.packages;
        const container = document.getElementById('content');

        // å°†å¯¹è±¡è½¬æ¢ä¸ºæ•°ç»„ä»¥ä¾¿æ’åºå’Œè¿‡æ»¤
        allPackages = Object.keys(packages).map(name => {
            return {
                name: name,
                version: packages[name],
                // æ ¸å¿ƒé€»è¾‘ï¼šæ‹¼æ¥æ–‡ä»¶å
                // æ ¼å¼: {name}_{version}_{arch}.ipk
                filename: `${name}_${packages[name]}_${arch}.ipk`
            };
        });

        // æŒ‰åç§°æ’åº
        allPackages.sort((a, b) => a.name.localeCompare(b.name));

        let html = `
            <table>
                <thead>
                    <tr>
                        <th>è½¯ä»¶åŒ…åç§°</th>
                        <th>ç‰ˆæœ¬</th>
                        <th style="text-align:right">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="pkg-list">
        `;

        allPackages.forEach(pkg => {
            html += generateRow(pkg, repoName);
        });

        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    // ç”Ÿæˆå•è¡Œ HTML
    function generateRow(pkg, path) {
        return `
            <tr class="pkg-row">
                <td class="pkg-name">${pkg.name}</td>
                <td class="pkg-ver">${pkg.version}</td>
                <td style="text-align:right">
                    <a href="${path}/${pkg.filename}" class="download-btn" download>â¬‡ ä¸‹è½½</a>
                </td>
            </tr>
        `;
    }

    // 5. æœç´¢è¿‡æ»¤åŠŸèƒ½
    function filterPackages() {
        const query = document.getElementById('search').value.toLowerCase();
        const rows = document.querySelectorAll('.pkg-row');
        
        rows.forEach(row => {
            const name = row.querySelector('.pkg-name').innerText.toLowerCase();
            if (name.includes(query)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
</script>

</body>
</html>