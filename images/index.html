<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›ºä»¶ä¸‹è½½ - ImmortalWrt Images</title>
    <style>
        :root { --primary: #0ea5e9; --bg: #f8fafc; --surface: #ffffff; --text: #334155; --border: #e2e8f0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; line-height: 1.6; }
        
        /* å¸ƒå±€å®¹å™¨ */
        .container { max-width: 1100px; margin: 0 auto; padding: 40px 20px; }
        
        /* å¤´éƒ¨å¯¼èˆª */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .header h1 { margin: 0; font-size: 1.8rem; color: #0f172a; }
        .nav-link { text-decoration: none; color: var(--primary); font-weight: 500; display: flex; align-items: center; gap: 5px; }
        .nav-link:hover { text-decoration: underline; }

        /* å¡ç‰‡æ ·å¼ */
        .card { background: var(--surface); border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 30px; margin-bottom: 30px; border: 1px solid var(--border); }
        .card-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 20px; border-bottom: 1px solid var(--bg); padding-bottom: 15px; }
        .card-header h2 { margin: 0; font-size: 1.25rem; }
        .version-badge { background: #dbeafe; color: #1e40af; padding: 4px 12px; border-radius: 99px; font-family: monospace; font-size: 0.9rem; font-weight: bold; }

        /* ä¿¡æ¯ç½‘æ ¼ */
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .info-item label { display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 4px; }
        .info-item span { font-weight: 600; color: #0f172a; font-family: monospace; font-size: 1rem; }

        /* è®¾å¤‡é€‰æ‹©å™¨ */
        .device-selector { margin-bottom: 25px; }
        .device-selector select { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; background-color: #fff; cursor: pointer; }
        .device-selector select:focus { border-color: var(--primary); outline: none; }

        /* ä¸‹è½½è¡¨æ ¼ */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 12px; color: #64748b; font-weight: 600; border-bottom: 2px solid var(--border); font-size: 0.9rem; }
        td { padding: 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .filename { font-family: monospace; color: #334155; font-weight: 600; }
        .hash { font-family: monospace; font-size: 0.8rem; color: #94a3b8; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; cursor: help; }
        
        /* æŒ‰é’® */
        .btn { display: inline-block; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 500; font-size: 0.9rem; transition: all 0.2s; border: none; cursor: pointer; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #0284c7; }
        .btn-copy { background: #f1f5f9; color: #475569; margin-left: 10px; font-size: 0.8rem; }
        .btn-copy:hover { background: #e2e8f0; }

        /* ä»£ç å— */
        /* ä»£ç é…ç½®åŒº */
        .config-area { background: #1e293b; color: #e2e8f0; padding: 20px; border-radius: 8px; overflow-x: auto; font-family: "JetBrains Mono", monospace; margin-top: 15px; position: relative; }
        .copy-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.1); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .copy-btn:hover { background: rgba(255,255,255,0.2); }
        #config-code {
            display: block;          /* è®©ä»£ç å—å˜æˆå—çº§å…ƒç´ ï¼Œç‹¬å ä¸€è¡Œ */
            white-space: pre;        /* ã€å…³é”®ã€‘ä¿ç•™æ‰€æœ‰çš„ç©ºæ ¼å’Œæ¢è¡Œç¬¦ï¼Œä¸è‡ªåŠ¨åˆå¹¶ */
            font-family: "JetBrains Mono", Consolas, monospace; /* ä¿æŒç­‰å®½å­—ä½“ */
            line-height: 1.5;        /* å¢åŠ è¡Œé«˜ï¼Œè®©ä»£ç æ›´æ˜“è¯» */
        }
        
        /* åŠ è½½ä¸é”™è¯¯çŠ¶æ€ */
        #loading { text-align: center; padding: 50px; color: #64748b; }
        .error-msg { background: #fee2e2; color: #991b1b; padding: 15px; border-radius: 8px; text-align: center; display: none; }
        
        /* è¾…åŠ©ç±» */
        .hidden { display: none; }
        footer { margin-top: 40px; border-top: 1px solid var(--border); padding-top: 20px; text-align: center; color: #94a3b8; font-size: 0.85rem; }
        .build-info { font-family: monospace; margin-bottom: 5px; }
        .build-info a { color: inherit; text-decoration: none; border-bottom: 1px dashed #cbd5e1; }
    </style>
</head>
<body>

<div class="container">
<div class="header">
    <div>
        <a href="/" class="nav-link">â† è¿”å›é¦–é¡µ</a>
        <h1 style="margin-top: 10px;">å›ºä»¶é•œåƒä¸‹è½½</h1>
    </div>
    
    <div style="display: flex; align-items: center; gap: 15px;">
        <div id="ver-display" class="version-badge hidden">Loading...</div>
        
        <a href="history.html" class="btn" style="background:white; border:1px solid var(--border); color:var(--text);">
            ğŸ•˜ å†å²ç‰ˆæœ¬
        </a>
    </div>
</div>

    <div id="error-box" class="error-msg"></div>

    <div id="loading">
        <svg style="width: 24px; height: 24px; animation: spin 1s linear infinite;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" stroke-opacity="0.25"></circle>
            <path d="M12 2a10 10 0 0 1 10 10" stroke-opacity="1"></path>
        </svg>
        <p>æ­£åœ¨è·å–ç‰ˆæœ¬ä¿¡æ¯...</p>
    </div>

    <div id="main-content" class="hidden">
        
        <div class="card">
            <div class="card-header">
                <h2>ğŸ“¦ ç‰ˆæœ¬æ¦‚å†µ</h2>
                <span id="build-target" style="color: #64748b; font-family: monospace;">-</span>
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <label>æ„å»ºç‰ˆæœ¬</label>
                    <span id="info-vercode">-</span>
                </div>
                <div class="info-item">
                    <label>Linux å†…æ ¸</label>
                    <span id="info-kernel">-</span>
                </div>
                <div class="info-item">
                    <label>Vermagic (Hash)</label>
                    <span id="info-magic" title="å†…æ ¸ç­¾å">-</span>
                </div>
                <div class="info-item">
                    <label>æ¶æ„ (Arch)</label>
                    <span id="info-arch">-</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>ğŸ’¾ é•œåƒæ–‡ä»¶</h2>
            </div>
            
            <div class="device-selector">
                <select id="device-select" aria-label="é€‰æ‹©è®¾å¤‡å‹å·">
                    <option value="">åŠ è½½è®¾å¤‡åˆ—è¡¨ä¸­...</option>
                </select>
            </div>

            <div class="table-container">
                <table id="download-table">
                    <thead>
                        <tr>
                            <th>æ–‡ä»¶ç±»å‹</th>
                            <th>æ–‡ä»¶å</th>
                            <th>SHA256 æ ¡éªŒç </th>
                            <th style="text-align: right;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="file-list-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ› ï¸ Opkg è½¯ä»¶æºé…ç½®</h2>
            <p>æ­¤é…ç½®å·²åŒ…å«å½“å‰ç‰ˆæœ¬çš„å†…æ ¸æ¨¡å—æº (kmods)ã€‚è¯·å°†å…¶å†…å®¹è¦†ç›–åˆ°è·¯ç”±å™¨çš„ <strong>/etc/opkg/distfeeds.conf</strong> æ–‡ä»¶ä¸­ã€‚</p>
            
            <div class="config-area">
                <button class="copy-btn" onclick="copyConfig()">å¤åˆ¶</button>
                <code id="config-code">
                    # æ­£åœ¨ç”Ÿæˆé…ç½®...
                </code>
            </div>
        </div>
    </div>
    <div class="card">
    	<h2>âš™ï¸å›ºä»¶é»˜è®¤å¯†ç </h2>
	<p>é»˜è®¤wifiå¯†ç ä¸º:<strong>12345678</strong></p>
	<p>é»˜è®¤ç®¡ç†å‘˜å¯†ç :<strong>password</strong></p>
    </div>
     <footer>
        <div id="version-info" class="build-info">
            <span>Build: <a href="#" id="commit-link">Checking...</a></span>
            <span style="margin: 0 8px;">â€¢</span>
            <span id="update-date">...</span>
        </div>
        &copy; 2026 Ethan | Powered by GitHub Pages
    </footer>
</div>


<script>
    // é…ç½®ï¼šä¸Šçº§ Packages ç›®å½•ç›¸å¯¹äº images/VERSION/ çš„ä½ç½®
    // å¦‚æœ images/v1.0/ å¯¹åº” packages/v1.0/ï¼Œåˆ™æ— éœ€ä¿®æ”¹
    // å¦‚æœ packages åœ¨æ ¹ç›®å½•ï¼Œåˆ™éœ€è¦å›é€€
    const CONFIG = {
        packagesBaseUrl: '../../packages' ,
        githubUser: 'Ye-Ethan',
        githubRepo: 'opwnwrt-opkg-source',
    };

    let currentData = null;
    let currentVersion = '';

    window.onload = async () => {
        try {
            await init();
        } catch (e) {
            showError("åˆå§‹åŒ–å¤±è´¥: " + e.message);
        }
        try {
            fetchGitHubInfo();
        } catch {
            //éšè—version-info
            document.getElementById('version-info').style.display = 'none';
        }
    };

    async function init() {
        // 1. è§£æ URL å‚æ•°
        const params = new URLSearchParams(window.location.search);
        let version = params.get('version');

        // 2. å¦‚æœæ²¡æœ‰ç‰ˆæœ¬å‚æ•°ï¼Œè¯·æ±‚ latest.json
        if (!version) {
            try {
                const latestRes = await fetch('latest.json?t=' + Date.now());
                if (!latestRes.ok) throw new Error("æ— æ³•åŠ è½½ latest.json");
                const latestData = await latestRes.json();
                version = latestData.latest_version;
            } catch (e) {
                // å¦‚æœ latest.json ä¸å­˜åœ¨ï¼Œå°è¯•æç¤ºç”¨æˆ·
                throw new Error("æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ latest.json");
            }
        }

        currentVersion = version;
        
        // 3. æ›´æ–° UI çŠ¶æ€
        document.getElementById('ver-display').textContent = version;
        document.getElementById('ver-display').classList.remove('hidden');

        // 4. åŠ è½½ç‰¹å®šç‰ˆæœ¬çš„ profiles.json
        // è·¯å¾„å‡è®¾ï¼šå½“å‰ç›®å½•/ç‰ˆæœ¬å·/profiles.json
        const profileUrl = `${version}/profiles.json`;
        
        try {
            const profileRes = await fetch(profileUrl);
            if (!profileRes.ok) throw new Error(`æ‰¾ä¸åˆ°ç‰ˆæœ¬ ${version} çš„å…ƒæ•°æ® (404)`);
            currentData = await profileRes.json();
            renderPage(currentData);
        } catch (e) {
            throw new Error(`åŠ è½½ç‰ˆæœ¬æ•°æ®å¤±è´¥: ${e.message}`);
        }
    }
   
    function copyConfig() {
        console.log('copyConfig called',document.querySelector('#config-code'));
        const text = document.querySelector('#config-code').textContent;
        navigator.clipboard.writeText(text).then(() => alert('é…ç½®å·²å¤åˆ¶ï¼'));
    }
    function renderPage(data) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');

        // 1. å¡«å……åŸºç¡€ä¿¡æ¯
        document.getElementById('info-vercode').textContent = data.version_code || data.version_number;
        document.getElementById('info-kernel').textContent = data.linux_kernel.version;
        document.getElementById('info-magic').textContent = data.linux_kernel.vermagic.substring(0, 8) + '...';
        document.getElementById('info-magic').title = data.linux_kernel.vermagic;
        document.getElementById('info-arch').textContent = data.arch_packages;
        document.getElementById('build-target').textContent = `Target: ${data.target}`;

        // 2. åˆå§‹åŒ–è®¾å¤‡ä¸‹æ‹‰
        const selector = document.getElementById('device-select');
        selector.innerHTML = '';
        const profiles = data.profiles;
        
        Object.keys(profiles).forEach((key, index) => {
            const profile = profiles[key];
            const title = profile.titles[0];
            const option = document.createElement('option');
            option.value = key;
            option.textContent = `${title.vendor} ${title.model} ${title.variant || ''}`;
            selector.appendChild(option);
            
            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
            if (index === 0) renderFileList(key);
        });

        // ç»‘å®šåˆ‡æ¢äº‹ä»¶
        selector.onchange = (e) => renderFileList(e.target.value);

        // 3. ç”Ÿæˆ Opkg é…ç½®
        renderOpkgConfig(data);
    }

    function renderFileList(profileKey) {
        const tbody = document.getElementById('file-list-body');
        tbody.innerHTML = '';
        
        const images = currentData.profiles[profileKey].images;
        // åŸºç¡€ä¸‹è½½è·¯å¾„ï¼šå½“å‰é¡µé¢åŒçº§ç›®å½• + ç‰ˆæœ¬å·ç›®å½•
        const basePath = `${currentVersion}/`;

        images.forEach(img => {
            const tr = document.createElement('tr');
            
            // ç®€åŒ–ç±»å‹æ˜¾ç¤º
            let typeLabel = img.type;
            if (img.type.includes('sysupgrade')) typeLabel = 'Sysupgrade (å‡çº§åŒ…)';
            else if (img.type.includes('factory')) typeLabel = 'Factory (è¿‡æ¸¡åŒ…)';
            else if (img.type.includes('initramfs')) typeLabel = 'Initramfs (æ•‘ç –)';

            tr.innerHTML = `
                <td><span style="font-weight:500; color:#475569">${typeLabel}</span></td>
                <td><a href="${basePath}${img.name}" class="filename" download>${img.name}</a></td>
                <td><span class="hash" title="${img.sha256}">${img.sha256}</span></td>
                <td style="text-align: right;">
                    <a href="${basePath}${img.name}" class="btn btn-primary">ä¸‹è½½</a>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderOpkgConfig(data) {
        // åŠ¨æ€æ¨å¯¼ URL
        // å‡è®¾ structure:
        // root/images/v1.0/index.html (current)
        // root/packages/aarch64_cortex-a53/base/ (generic)
        // root/packages/kmods/v1.0/ (kernel specific)

        // è¿™é‡Œéœ€è¦éå¸¸å°å¿ƒè·¯å¾„å›é€€ã€‚
        // å½“å‰é¡µé¢åœ¨ root/images/
        // æˆ‘ä»¬éœ€è¦æŒ‡å‘ root/packages/
        
        const origin = window.location.origin;
        // å¦‚æœé¡µé¢éƒ¨ç½²åœ¨å­ç›®å½•ï¼Œè¿™é‡Œæœ€å¥½ç”¨ç›¸å¯¹è·¯å¾„æ¨å¯¼ç»å¯¹è·¯å¾„ï¼Œæˆ–è€…ç›´æ¥å‡è®¾ç›¸å¯¹è·¯å¾„
        // ä¸ºäº†ç®€ä¾¿ï¼Œæˆ‘ä»¬ç”ŸæˆåŸºäº HTTP çš„ç»å¯¹è·¯å¾„
        
        // å¯»æ‰¾ path prefix (å»æ‰ images/index.html)
        const pathPrefix = window.location.pathname.replace(/\/images\/.*$/, '');
        
        // æ„å»ºé€šç”¨åŒ…è·¯å¾„ (base, luci)
        // å‡è®¾ packages åœ¨æ ¹ç›®å½•ä¸‹çš„ packages/ARCH
        const arch = data.arch_packages;
        const genericBase = `${origin}${pathPrefix}/packages/${arch}`;
        
        // æ„å»ºå†…æ ¸åŒ…è·¯å¾„ (kmods)
        // å‡è®¾ packages/kmods/VERSION
        // ç”¨æˆ·æåˆ° images å’Œ packages æä¾› jsonï¼Œè¿™é‡Œæˆ‘ä»¬å‡è®¾ç›®å½•ç»“æ„æ˜¯å¯¹åº”çš„
        const kmodBase = `${origin}${pathPrefix}/packages/kmods/${currentVersion}`;

        let conf = `# ImmortalWrt Feeds - ${currentVersion}\n`;
        conf += `# Arch: ${arch} | Kernel: ${data.linux_kernel.version}\n\n`;
        
        conf += `src/gz custom_base ${genericBase}/base\n`;
        conf += `src/gz custom_luci ${genericBase}/luci\n`;
        conf += `src/gz custom_packages ${genericBase}/packages\n`;
        conf += `src/gz custom_routing ${genericBase}/routing\n`;
        conf += `src/gz custom_telephony ${genericBase}/telephony\n`;
        conf += `src/gz custom_management ${genericBase}/nikki\n`;
        conf += `\n# Kernel Modules (Hash åŒ¹é…)\n`;
        conf += `src/gz custom_core ${kmodBase}\n`; // è¿™ä¸€å±‚ç›®å½•é‡Œåº”è¯¥æœ‰ Packages.gz

        document.getElementById('config-code').textContent = conf;
    }

    function copyConfig() {
        const text = document.getElementById('config-code').textContent;
        navigator.clipboard.writeText(text).then(() => alert('é…ç½®å·²å¤åˆ¶ï¼'));
    }

    function showError(msg) {
        const box = document.getElementById('error-box');
        box.textContent = msg;
        box.style.display = 'block';
        document.getElementById('loading').classList.add('hidden');
    }
    function fetchGitHubInfo() {
        fetch(`https://api.github.com/repos/${CONFIG.githubUser}/${CONFIG.githubRepo}/commits?per_page=1`)
            .then(r => r.ok ? r.json() : null)
            .then(data => {
                if (!data || !data[0]) return;
                const commit = data[0];
                const date = new Date(commit.commit.committer.date).toLocaleString();
                
                document.getElementById('commit-link').textContent = commit.sha.substring(0, 7);
                document.getElementById('commit-link').href = commit.html_url;
                document.getElementById('update-date').textContent = date;
            })
            .catch(() => {});
    }
    
    // æ³¨å…¥ CSS åŠ¨ç”»
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes spin { 100% { transform: rotate(360deg); } }
    `;
    document.head.appendChild(style);
</script>

</body>
</html>
