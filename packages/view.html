<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»“åº“æµè§ˆ - Packages Viewer</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --surface: #ffffff; --text: #334155; --border: #e2e8f0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 20px; line-height: 1.5; }
        
        .container { max-width: 1000px; margin: 0 auto; background: var(--surface); padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        
        /* å¤´éƒ¨ */
        .header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--bg); padding-bottom: 20px; margin-bottom: 20px; gap: 10px; }
        .header h1 { margin: 0; font-size: 1.5rem; color: #0f172a; display: flex; align-items: center; gap: 10px; }
        .repo-badge { font-size: 0.9rem; background: #e0f2fe; color: #0284c7; padding: 4px 10px; border-radius: 6px; font-family: monospace; }
        .back-link { text-decoration: none; color: #64748b; font-weight: 500; font-size: 0.95rem; transition: color 0.2s; }
        .back-link:hover { color: var(--primary); }
        
        /* æœç´¢æ¡† */
        .search-box { position: relative; margin-bottom: 20px; }
        #search { width: 100%; padding: 12px 15px; padding-left: 40px; font-size: 16px; border: 2px solid var(--border); border-radius: 8px; box-sizing: border-box; transition: border-color 0.2s; outline: none; }
        #search:focus { border-color: var(--primary); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .search-stats { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 0.85rem; color: #94a3b8; }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 12px; color: #64748b; font-weight: 600; border-bottom: 2px solid var(--border); font-size: 0.9rem; }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover { background-color: #f1f5f9; }
        
        .pkg-name { color: #0f172a; font-weight: 600; font-family: "JetBrains Mono", monospace; font-size: 1rem; }
        .pkg-ver { color: #64748b; font-family: monospace; font-size: 0.9rem; }
        
        /* æŒ‰é’®ç»„ */
        .action-group { display: flex; gap: 8px; justify-content: flex-end; }
        .btn { display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 0.85rem; font-weight: 500; transition: all 0.2s; border: none; cursor: pointer; }
        .btn-download { background: #eff6ff; color: var(--primary); }
        .btn-download:hover { background: var(--primary); color: white; }
        .btn-copy { background: #f1f5f9; color: #64748b; }
        .btn-copy:hover { background: #e2e8f0; color: #334155; }

        /* çŠ¶æ€æç¤º */
        .status-msg { text-align: center; padding: 50px; color: #94a3b8; }
        .error { color: #ef4444; background: #fee2e2; padding: 15px; border-radius: 8px; text-align: center; }

        /* é¡µè„š */
        footer { margin-top: 40px; border-top: 1px solid var(--border); padding-top: 20px; text-align: center; color: #94a3b8; font-size: 0.85rem; }
        .build-info { font-family: monospace; margin-bottom: 5px; }
        .build-info a { color: inherit; text-decoration: none; border-bottom: 1px dashed #cbd5e1; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>
            ğŸ“¦ ä»“åº“æµè§ˆ 
            <span id="repo-badge" class="repo-badge" style="display:none">...</span>
        </h1>
        <a href="index.html" class="back-link">â† è¿”å›å¤§å…</a>
    </div>

    <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="search" placeholder="è¾“å…¥åŒ…åæœç´¢ (æ”¯æŒæ­£åˆ™)..." autocomplete="off">
        <span id="result-count" class="search-stats"></span>
    </div>

    <div id="content" class="table-container">
        <div class="status-msg">æ­£åœ¨åŠ è½½ç´¢å¼•æ–‡ä»¶...</div>
    </div>

    <footer>
        <div id="version-info" class="build-info">
            <span>Build: <a href="#" id="commit-link">Checking...</a></span>
            <span style="margin: 0 8px;">â€¢</span>
            <span id="update-date">...</span>
        </div>
        &copy; 2026 Ethan | Powered by GitHub Pages
    </footer>
</div>

<script>
    // é…ç½®éƒ¨åˆ†
    const CONFIG = {
        githubUser: 'Ye-Ethan',
        githubRepo: 'opwnwrt-opkg-source', // æ›¿æ¢ä¸ºçœŸå®ä»“åº“å
        jsonFileName: 'index.json' // ä½ çš„ç´¢å¼•æ–‡ä»¶å
    };

    // å…¨å±€æ•°æ®ç¼“å­˜
    let allPackages = [];
    let currentRepoPath = '';

    // åˆå§‹åŒ–
    window.onload = async () => {
        // 1. è·å– URL å‚æ•°
        const params = new URLSearchParams(window.location.search);
        const repoPath = params.get('repo'); // ä¾‹å¦‚: packages/aarch64_cortex-a53/base
        
        if (!repoPath) {
            showError("é”™è¯¯ï¼šURL ä¸­æœªæŒ‡å®šä»“åº“è·¯å¾„ (ä¾‹å¦‚ ?repo=base)");
            return;
        }

        currentRepoPath = repoPath.replace(/\/$/, ''); // å»é™¤æœ«å°¾æ–œæ 
        
        // æ›´æ–°æ ‡é¢˜
        const shortName = currentRepoPath.split('/').pop();
        document.title = `${shortName} - Packages`;
        const badge = document.getElementById('repo-badge');
        badge.textContent = shortName;
        badge.style.display = 'inline-block';

        // 2. åŠ è½½æ•°æ®
        await loadPackageData(currentRepoPath);

        // 3. ç»‘å®šæœç´¢äº‹ä»¶
        document.getElementById('search').addEventListener('input', (e) => filterPackages(e.target.value));

        // 4. è·å– GitHub ç‰ˆæœ¬ä¿¡æ¯
        fetchGitHubInfo();
    };

    async function loadPackageData(path) {
        try {
            // æ‹¼æ¥ index.json è·¯å¾„
            const url = `${path}/${CONFIG.jsonFileName}`;
            const res = await fetch(url);
            
            if (!res.ok) throw new Error(`æ— æ³•æ‰¾åˆ°ç´¢å¼•æ–‡ä»¶ (${res.status})`);
            
            const data = await res.json();
            
            // æ•°æ®é¢„å¤„ç†
            const arch = data.architecture || 'all';
            
            // å…¼å®¹ä¸¤ç§æ ¼å¼ï¼š
            // æ ¼å¼ A: { packages: { "name": "version", ... } } (ç®€å•KV)
            // æ ¼å¼ B: { packages: [ {name:..., version:...}, ... ] } (æ•°ç»„)
            
            if (Array.isArray(data.packages)) {
                allPackages = data.packages.map(p => ({
                    name: p.name,
                    version: p.version,
                    filename: p.filename || `${p.name}_${p.version}_${arch}.ipk`
                }));
            } else {
                allPackages = Object.keys(data.packages).map(name => ({
                    name: name,
                    version: data.packages[name],
                    filename: `${name}_${data.packages[name]}_${arch}.ipk`
                }));
            }

            // æ’åº
            allPackages.sort((a, b) => a.name.localeCompare(b.name));
            
            // æ¸²æŸ“
            renderTable(allPackages);
            updateStats(allPackages.length);

        } catch (e) {
            showError(`åŠ è½½å¤±è´¥: ${e.message}<br><small>è¯·ç¡®ä¿ '${path}/${CONFIG.jsonFileName}' å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®</small>`);
        }
    }

    function renderTable(pkgs) {
        const container = document.getElementById('content');
        
        if (pkgs.length === 0) {
            container.innerHTML = '<div class="status-msg">æœªæ‰¾åˆ°åŒ¹é…çš„è½¯ä»¶åŒ…</div>';
            return;
        }

        // é™åˆ¶æ¸²æŸ“æ•°é‡ä»¥é˜²å¡é¡¿ (ç‰¹åˆ«æ˜¯å‡ åƒä¸ªåŒ…æ—¶)
        const displayPkgs = pkgs.slice(0, 500); // é¦–æ¬¡åªæ¸²æŸ“å‰500ä¸ªï¼Œå®é™…ç”Ÿäº§ä¸­å¯ä»¥åšåˆ†é¡µï¼Œè¿™é‡Œç®€å•å¤„ç†
        const hasMore = pkgs.length > 500;

        let html = `
            <table>
                <thead>
                    <tr>
                        <th>è½¯ä»¶åŒ…åç§°</th>
                        <th>ç‰ˆæœ¬</th>
                        <th style="text-align:right">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
        `;

        displayPkgs.forEach(pkg => {
            const downloadUrl = `${currentRepoPath}/${pkg.filename}`;
            html += `
                <tr>
                    <td class="pkg-name">${pkg.name}</td>
                    <td class="pkg-ver">${pkg.version}</td>
                    <td style="text-align:right">
                        <div class="action-group">
                            <button class="btn btn-copy" onclick="copyText('${pkg.name}')" title="å¤åˆ¶åŒ…å">ğŸ“„</button>
                            <a href="${downloadUrl}" class="btn btn-download" download>â¬‡ ä¸‹è½½</a>
                        </div>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        if (hasMore) {
            html += `<div style="text-align:center; padding:10px; color:#94a3b8; font-size:0.9rem;">ä»…æ˜¾ç¤ºå‰ 500 ä¸ªç»“æœï¼Œè¯·ä½¿ç”¨æœç´¢æŸ¥æ‰¾æ›´å¤š...</div>`;
        }
        
        container.innerHTML = html;
    }

    function filterPackages(query) {
        query = query.toLowerCase().trim();
        
        if (!query) {
            renderTable(allPackages);
            updateStats(allPackages.length);
            return;
        }

        const filtered = allPackages.filter(p => 
            p.name.toLowerCase().includes(query) || 
            p.filename.toLowerCase().includes(query)
        );

        renderTable(filtered);
        updateStats(filtered.length);
    }

    function updateStats(count) {
        document.getElementById('result-count').textContent = `å…± ${count} ä¸ªåŒ…`;
    }

    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert(`å·²å¤åˆ¶: ${text}`);
        });
    }

    function showError(msg) {
        document.getElementById('content').innerHTML = `<div class="error">${msg}</div>`;
    }

    // GitHub API é›†æˆ
    function fetchGitHubInfo() {
        fetch(`https://api.github.com/repos/${CONFIG.githubUser}/${CONFIG.githubRepo}/commits?per_page=1`)
            .then(r => r.ok ? r.json() : null)
            .then(data => {
                if (!data || !data[0]) return;
                const commit = data[0];
                const date = new Date(commit.commit.committer.date).toLocaleString();
                
                document.getElementById('commit-link').textContent = commit.sha.substring(0, 7);
                document.getElementById('commit-link').href = commit.html_url;
                document.getElementById('update-date').textContent = date;
            })
            .catch(() => {});
    }
</script>

</body>
</html>